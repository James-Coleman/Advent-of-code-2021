import Foundation

var greeting = "Hello, playground"

extension Collection {
    subscript (safe index: Index) -> Element? {
        if indices.contains(index) {
            return self[index]
        } else {
            return nil
        }
    }
}

let testString = "..#.#..#####.#.#.#.###.##.....###.##.#..###.####..#####..#....#..#..##..##"

testString[String.Index(utf16Offset: 0, in: testString)]
testString[String.Index(utf16Offset: 1, in: testString)]
testString[String.Index(utf16Offset: 2, in: testString)]
testString[String.Index(utf16Offset: 3, in: testString)]
testString[String.Index(utf16Offset: 4, in: testString)]
testString[String.Index(utf16Offset: 5, in: testString)]
testString[String.Index(utf16Offset: 10, in: testString)]
testString[String.Index(utf16Offset: 20, in: testString)]
testString[String.Index(utf16Offset: 30, in: testString)]
testString[String.Index(utf16Offset: 34, in: testString)]
testString[String.Index(utf16Offset: 40, in: testString)]
testString[String.Index(utf16Offset: 50, in: testString)]
testString[String.Index(utf16Offset: 60, in: testString)]
testString[String.Index(utf16Offset: 70, in: testString)]

let exampleInput = """
#..#.
#....
##..#
..#..
..###
"""

let exampleAlgorithm = """
..#.#..#####.#.#.#.###.##.....###.##.#..###.####..#####..#....#..#..##..###..######.###...####..#..#####..##..#.#####...##.#.#..#.##..#.#......#.###.######.###.####...#.##.##..#..#..#####.....#.#....###..#.##......#.....#..#..#..##..#...##.######.####.####.#.#...#.......#..#.#.#...####.##.#......#..#...##.#.##..#...##.#.##..###.#......#.#.......#.#.#.####.###.##...#.....####.#..#..#.##.#....##..#.####....##...##..#...#......#.#.......#.......##..####..#...#.#.#...##..#.#..###..#####........#..####......#..#
"""

enum Error: Swift.Error {
    case couldNotCreateInt(from: String)
}

func nextImage(from input: String, algorithm: String) throws -> [[Character]] {
    
    let mapped = input.components(separatedBy: .newlines).map { $0.map { $0 == "." ? "0" : "1" } }
    
    guard let firstRow = mapped.first else { return [] }
    
    var arrayToReturn = [[Character]]()
    
    for rowIndex in -1...mapped.count {
        var characterArray = [Character]()
        
        for columnIndex in -1...firstRow.count {
            let topLeft = mapped[safe: rowIndex - 1]?[safe: columnIndex - 1] ?? "0"
            let topMiddle = mapped[safe: rowIndex - 1]?[safe: columnIndex] ?? "0"
            let topRight = mapped[safe: rowIndex - 1]?[safe: columnIndex + 1] ?? "0"
            let centreLeft = mapped[safe: rowIndex]?[safe: columnIndex - 1] ?? "0"
            let centreMiddle = mapped[safe: rowIndex]?[safe: columnIndex] ?? "0"
            let centreRight = mapped[safe: rowIndex]?[safe: columnIndex + 1] ?? "0"
            let bottomLeft = mapped[safe: rowIndex + 1]?[safe: columnIndex - 1] ?? "0"
            let bottomMiddle = mapped[safe: rowIndex + 1]?[safe: columnIndex] ?? "0"
            let bottomRight = mapped[safe: rowIndex + 1]?[safe: columnIndex + 1] ?? "0"
            
            let binaryNumber = "\(topLeft)\(topMiddle)\(topRight)\(centreLeft)\(centreMiddle)\(centreRight)\(bottomLeft)\(bottomMiddle)\(bottomRight)"
            
            guard let int = Int(binaryNumber, radix: 2) else { throw Error.couldNotCreateInt(from: binaryNumber) }
            
            let newPixel = algorithm[String.Index(utf16Offset: int, in: algorithm)]
            
            characterArray += [newPixel]
        }
        
        arrayToReturn += [characterArray]
    }
    
    return arrayToReturn
}

func nextImage(from input: [[Character]], algorithm: String) throws -> [[Character]] {
    let mapped = input.map { $0.map { $0 == "." ? "0" : "1" } }
    
    guard let firstRow = mapped.first else { return [] }
    
    var arrayToReturn = [[Character]]()
    
    for rowIndex in -1...mapped.count {
        var characterArray = [Character]()
        
        for columnIndex in -1...firstRow.count {
            let topLeft = mapped[safe: rowIndex - 1]?[safe: columnIndex - 1] ?? "0"
            let topMiddle = mapped[safe: rowIndex - 1]?[safe: columnIndex] ?? "0"
            let topRight = mapped[safe: rowIndex - 1]?[safe: columnIndex + 1] ?? "0"
            let centreLeft = mapped[safe: rowIndex]?[safe: columnIndex - 1] ?? "0"
            let centreMiddle = mapped[safe: rowIndex]?[safe: columnIndex] ?? "0"
            let centreRight = mapped[safe: rowIndex]?[safe: columnIndex + 1] ?? "0"
            let bottomLeft = mapped[safe: rowIndex + 1]?[safe: columnIndex - 1] ?? "0"
            let bottomMiddle = mapped[safe: rowIndex + 1]?[safe: columnIndex] ?? "0"
            let bottomRight = mapped[safe: rowIndex + 1]?[safe: columnIndex + 1] ?? "0"
            
            let binaryNumber = "\(topLeft)\(topMiddle)\(topRight)\(centreLeft)\(centreMiddle)\(centreRight)\(bottomLeft)\(bottomMiddle)\(bottomRight)"
            
            guard let int = Int(binaryNumber, radix: 2) else { throw Error.couldNotCreateInt(from: binaryNumber) }
            
            let newPixel = algorithm[String.Index(utf16Offset: int, in: algorithm)]
            
            characterArray += [newPixel]
        }
        
        arrayToReturn += [characterArray]
    }
    
    return arrayToReturn
}

func litPixels(in input: [[Character]]) -> Int {
    input.reduce(0) { partialResult, row in
        partialResult + row.filter { $0 == "#" }.count
    }
}

func reduced(image: [[Character]]) -> String {
    image.reduce("") { soFar, next in
        soFar + next.reduce("") { soFar, next in
            "\(soFar)\(next)"
        } + "\n"
    }
}

do {
    let exampleGen1 = try nextImage(from: exampleInput, algorithm: exampleAlgorithm)
    let exampleGen1Reduced = reduced(image: exampleGen1)
    print(exampleGen1Reduced)
    
    print("---")
    
    let exampleGen2 = try nextImage(from: exampleGen1, algorithm: exampleAlgorithm)
    let exampleGen2Reduced = reduced(image: exampleGen2)
    print(exampleGen2Reduced)
    litPixels(in: exampleGen2)
} catch {
    error
}

let puzzleAlgorithm = """
#####.##....##....##.#.....##....##..########.#.##.#.#.##.#..##.#.####.######.#####.######.##..#######.#.#...#..#.####..####...#.####..#......#...#...##.#.....#....#..###.#..##....#.#....#...##.###.#.#..##.......####.........#.#.###.#.#.....#..##..##.#.##..###.##.###.#....#.#..##.#.......###..#.#.#.#.#.....#..#.###.##..##...#....##...##.##...##.#..####.#...#.####...####..#####.#####.#.##...#.###.#######.###..#..##.#.#..#.#.#######.#####.#.##.#.#...##.######.#...##.##.#.........##...##.....#.###.#.##.#.####.
"""

let puzzleInput = """
..###.#.#...##.#....#..##....##.#.#......#.##.##...###..#.##...#..#......#..#....###.###..##.#..#.##
.#...#..#.##.##....###.##.######.#.##..#..#..#.##.#.###.#..#..##...#..##...######.#..####.#.#.#..##.
.##.#.##.#.....###.#.#...#####.#.#.#....#....##...#.....##.#...##....##.#.#.#..##.##...#..#..#..#..#
#.###.###.#.#.#....##.#.....#.#.#.#...#.#.#####....#.#.##.###..##..#..#.#...#.....#....#.###.#..#...
#.#.##..#..###..##...####.#....#.#.#.###.##..#....##.#..##.#...####.....#.#..##.##....######..##.#..
.#..#..##..#.#.##.####..#..#..##.#.#..##.##.###....#.#.####..#.#.####..##.###...#..#.#....#..#..###.
..##.#####..#...##.#...#####...#.##....##.###...#.#.#.##.#.####.##..#.#.#..###...#..####......###.##
....#......###.#...###..#####.#.##.#.#####..####..##...#..#.####.#.##########.######...####.###.####
###.####.#.###.#..#.##.#.#.#.####.##...##.....#..#.###..####..#.#.#..#######..###.....#..##...#....#
.###.#.#######.#..###.##..#.#..#..######......##.#.##..#....##...#....###.######.#.#.#.......##.....
#...#.####....#...#.####.##..#.#####.#..####.###.#...##....##..##.#.##..#.###.##..###..##..#.#...##.
..#..##.##.#..#.###.......#..###...##.###..#.##.#...##...#..####.##.######..#.#.#.#..#####.#########
####.##..###..###.##.#.####.##.....#.###..#..##.#...###..#.##...#...###.######.##..#..#####..#.#.###
######.##...##.......#.##...#.####.#.##.#.#..##.#.#.##.#...##..#.##.##.##.####.####..##...#...##.#.#
#.##...##...#..#.##.#.##.#####....#.##.###..#####.##.###.###..##.....#####..#...#..#.#.##.##.#.##.#.
.##.#...#.#..###.#.##.#..#.....########...#..##..##..##..###.....##...#.#.##.###.#.#####..##..##..#.
#.#.#......####...#...###..##.##.#.##.#....#.#.######...##.#...#.##.##..#...####...#...##.#.####.##.
#..###..#.....#..###...#.#.##.######....#.#...##..######.#.###.###.......###...#.....#####.....#.###
#.#.##...##.###..#.###.#.##..##.##..#.#.########........#####.#.###.#.##.#.###.#..####..#.#..##..###
#...##...###.#.#.##.....#.##.###.#..##..#.###..#.#.##.#.##..#..#.#...#.#.#####..######.#.#.##..#.#..
#####.#....#.#..###.#....#.##..#.###.#.......###..######..#.##.###..######.#.##.#..######.##..##.#..
##...##...###.#.###.#.####...###.######...#...#########.#.....#...##.#.....#..###..#..##..#.#####...
#.###..#.#.#.##.....#...#.#..#...##...####..##..##.##............#...#...#..#.###..#....#.#.#.#.....
.##..###.#...##...#...#####.##....#.#...#.##.#.##..##..#.##..#...##........#.....#...##...#..#.#.#.#
.#.#.#.##..#...###.####.##.......##.###..#.##.#####...#.#.#####.####..####.#####...######..#.##.....
.##...#.##..#..#...#......###....#.#..##.##..#...##.#.#..#####.#.######.####...###......#.....##...#
...#.#....#.#.#...###..##..#.####.#..##...##.#.##.....#...#.#.#....#.#.##.#..#....#.####...#.....###
##....#.####........##...#..###.#.##..##..#.....####.#.###.##.#.##....###.##.#..##.###.##..##..##..#
#..##.....#....###.##....#.#.....####.###..####...#.#####..#.#..##..#.##.#........#.#.#.##.###.#.##.
#..######.####..##...#.#...#########...#..#...###..##.###.....#.#..##.#....#..#.#.#.........#..#.#.#
##.....#..###.##..##..#.#..###.#.#.##.###....#.##....#.###...#.#.##.#..#.#.###.###.##....###...#.##.
....#####.#......#..###...##.#........##..#.#####..#.#####...#.##..##.#..#..#.#.#....#..#..#...###.#
.###.##.##......#.###.#.#.##..##.#..#.#.#..#..#...##.##..#.########.##..##.#.#..#...####.###.##.##.#
.#.####....#..##.#.....###.##.##..#.##...#.....#..#.......#.#..#..###.#..###..##.###..##..#.##...#..
#.....####.###..##.#....#####......##.#..##..##.#####....###......##.#...##.#.#...#####..#####.####.
..###..#..##...##.#.####...#########.###.#.#.##...#..#..##..###.##.#..###.#.#..##.....#.#..#.###.#..
###...#.#....##.#..#....###......#######..##.####.#.##.#.#.#..#....##.##....#..#####.##.#....####..#
...##.###....#..#....#.#.#...##.#.#.###.....##..#####...#.###.##....##..###.##.##.###..#.##..##.##..
#.######....#.###..##..#.##..###.##...##.#.###.#.#....#.#######..#...#..#.#..#...#.#..##...##.#...##
.##.#...##.###.#..##..#....###.#..###..#....#..##..#.#....#.####.#.#.#.#########.#..###.#..#....####
...#.##..#####..#..##..#.##.####...###..###.#.#.#.#.##.###.######.#.#..#...###.##.#...##.#.#.#.###.#
#..####...#####...#.##..##..##.#####..#.#.##.#...#..#.###.##...#.#.####.##.######..#.##....########.
#.#.###..##.#.#..#.#..#.#########.#.#...#..##.#.#..##..#.#.###.#..#.#####.##.#.##.#.##......###.##.#
.#.###..##.##...####.##..##..####.....#..#.....#..#...##.##.#...#..#..#....#####....#.#..#.##.##.##.
.#.#.##...##..#.####.##..#.....##.##....###.##.....#..#.######...##..#.#...#####...#..#...#.#.###.##
.##.##.#.##.....######.#.#.....##..##.....#...#.#.#..###.#.#.#....#.#...#..##.##.#...##.#..##..###.#
.#.##...#.####.##..#..#.#....##.......#.#.###.##.#.####.##.#.##.#...#.#.#.#######.##....#..#.#.##..#
......###.#.#.##.#####..####...#...#.##....###.#####..##.##.......###..#.##..#..#..#.#..##.#...###..
.#..#.##..#.#.##..#..#######.........##...###...#.##..##..#.###.#...#...#.##.#..#####...#..#.#######
.#.#.#.#....##...###..###.##########.#..#.##...##.##.....#.#.....#..##.##...##.....####.##..####.#..
.#.##....#.#....#..#.###..#.....#...#.#.#...#.#..#.#.##.##...#...###..#....#.#.#####.####.#.####.##.
..#.#.#..#########.##.#....#.###.##.###.#.#..###.#..####.#..#.#...###...##...##..#.##.#..######..#..
#.#.#.#####.######.#.##....###.#.###.###.....#.#.##.#..###..##...##.####...##.#..####.#.#.....#...##
#.##.#.#..###....#.##..######......#####.##.##......##.#.###.#...##......##.###.#.##...#.#.#.......#
#####.##....#..#####.#.###...#.###.#.##..##....#.###...#...##.###..#####...#.###.#.#.##....#.#.#..##
#.##.##....#..#.#...##.....###.#..###.#.###...#..#..##..##.#.#.###....#######.#.#...#...#.#.#..#.#.#
##.#####...#.#.........##.###..#.#..###..#.##...#...#.##..#.##......#...#.#..#..#..#..#.....##.....#
.#.##..###.#..#..###...#.##.##..##.....###.#.#.#####.##.#.###................#..#.##..##....#.#.###.
.....##.....####...#.####......#....#.####.#####.###.#..###.....#....####.####..#.##..###.##..#.....
.#..###.#..####...#..#..##.###....#.#.#..#...#.###.#...#..#..#.#..#.#...#...#.###...#.##...###.####.
#.###....#..#...#..#.#...##.#..##....#.#######.#...###.##.#.#...#.....##.##....####.#..####.##.##.#.
.##.#.###.#..#.###..#.##..#.....##..##....##...#########.#.###....###....##....##...#..#......#...#.
######.##.###.####..####...##........###.#.#...###.##..#.#....#.......##..##..#.....#.##......#...#.
....##..#.##...##....##.#...##.##..#####..######.#...###.####.#####..##...#.#.##.#........#.##.##.##
#####..#.#..#########...#####..#..#...###..##.###..##..#....#...####.#.##.#..#.##.....#..#...###...#
.#.....##....##.....##..####...#..#........#.....##.###.##.#....#.#.###..#..#.#...##.##.#.###.##.#..
#####...###.###.#.#######...##.#....#....#....#...##..##...#...#.#..###.#...#.##.....#.#..##.#.##.#.
#####....#..###..#.#....###.####.....######....######.##....#.###..###.####..#...###.#..#.########..
###......#.#...#.#.##.#.#.#..###..#.####...#.###..#.###.##.#...#..#..##..##.######..#..#.##.#.#####.
...#...#####...#.########.#.#####.......###...###.#.##.##.#...######..#.#..##.#....#..#..#.##...#..#
####........#..##..#......##...#.#.##..#.##.#.####...#.####.##.##.#.#..##..#....#...##......#..##.#.
.######...#.###..####....#.#....##.......#.#.....####.....##.#####.##.#..#.#.###..#.#.#.#..#..###.##
#..#.#.#.#..#.##....#.##.#.###....##.#..###.#...#.###...#..####.##.....#.#####.####...#.##.#.#####.#
..#####..#...#..#.#.##.#...###...#.......#....#..#..##..###.#####..#.#..#...###.#.#.##.....##...##..
##.#.#...##...###......#..#..##..###..##......#..#.##.##..##...#..#.#.#.#####.#..#..##.##.##..##.#..
#.##...#...#...###..#.##..##....#....###..#...#.###.#..##...###.##.#.#..##..####.####..##.##.##.##.#
#...#######.###.##....#..###.#.#......#.####..#..##..#.#.###...#....###.....#.#....#.#.##.....#.##.#
..#.##...#.#....##....#..#####..##.#.#########...#.##.##.###..##...##..#...###..###...#...##....#.#.
#.#.###.##....#.#.###.....#..#.##.#...##.####...###.......#.####.#.#..##...###.....##.#.####..##.##.
.#####.###.#.##..#...#....#..##..##.##.##.####...#......##.#.#..#.....#.#..##...####.##..#.##.##....
....##.#..#....#....##..#.##...#..#...###..#..########.#..#..#..####..#.###.#####..###.##.#...#..###
.####...###.#...#.#.#.#.#..#.###.#.#.#..#.##..#....#####..#..#..#.......#..#..####.##.#.#..##.####.#
.#.#.###...#..###.#..##.##..#..#..#..###..#.####..###..#.#.....#.#.#.#.##...#..##..##..#........#.#.
#.##.#.....#.......##.##...#.##...##.#.#.#..#.#####.#.##.##.#...####.#..#....#.##.###....#.....##.#.
##..##.#..#..#.##..##.##.###.#....#..#...#.##.#...##.####.#.#..##...##.#...#..#..###...##..#.#......
.......#...#.####..#...###.#.##.##..##.#.##..##.##.###..#...##..#.###.##....#.#.#..#.#######.......#
....#####.###.#.#..#.##.####..#...####...###..#..####......###..####.###..#...#.#.##....##......##..
#.##.#.#.##..#.#....##.###...#..##..#.#..####.....####.#######.#..#..######.#.#...#.####......#.##.#
.#.#.###..#.##..#.#.###.###..#..#...#.#.#.##..##..#..#..#..#........##..#.##..#.#....#..#....##..#..
.#...##..#..#..###.#####.#.##.##..#.#.#####........##..#..#....###....####..#.##..####.#.#######.#..
#..#.####.###....###....####.....#.#.###..##..#.######.#.....#..#.##.#..#.#.######....#...#####....#
#...#.#.#.....###..#.#..#.######....#.##..#.#.#.##.##.##.......#...##..###.#.##..###.###.##..#####.#
#..###.###.#..##...#.####.#.########.###.#####.##.##.####..#..######...##..#.....#.##..#..#....#...#
###..###.##.#...###.#..##....##.#..#.##..#........##..##.#..#.#..#.#...##..#...#.###.#.#.#..#.##....
..#.##.....#.#####.#.#..#......##.##.##.#.##.####.#..#..#.##..##.###.#.###.##...#....#..##.###..#.#.
.##..#..#..#..##.##.#..##.#..##.#...##...#.##........##........#.#..###.###..###.##.#...##.####.#.##
.#.########....#.....#....##...#...#.##.#....##.#.#....##.#..#.###.#####......#...####.####..###.##.
...#..#.##.##.......#.......###.##.##..###.#.#....##.##.#.#....#.##.....#....##.....#.#...#...##..#.
####..#.......#..##...#..#...########.##...####..###.###..##.#.###.#..##.###.#..##.#.#...#..##..#.#.
...##...#.###.#.....#..#.###..#...###.###.#.######.####.#...##.##.###.##.....#.##..##.#.####..###.#.
"""

//do {
//    let puzzleGen1 = try nextImage(from: puzzleInput, algorithm: puzzleAlgorithm)
//    let puzzleGen2 = try nextImage(from: puzzleGen1, algorithm: puzzleAlgorithm)
//    litPixels(in: puzzleGen2)
//} catch {
//    error
//}
